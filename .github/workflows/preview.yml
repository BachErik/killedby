name: Deploy Preview to Kubernetes

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  deploy-preview:
    if: ${{ github.event.action != 'closed' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy to Kubernetes
      uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      with:
        args: |
          apply -f - <<EOF
          apiVersion: v1
          kind: Namespace
          metadata:
            name: killedbypr${{ github.event.pull_request.number }}

          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: killedby
            namespace: killedbypr${{ github.event.pull_request.number }}
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: killedby
            template:
              metadata:
                labels:
                  app: killedby
              spec:
                containers:
                - name: killedby
                  image: bacherik/killedby:pr-${{ github.event.pull_request.number }}
                  env:
                  - name: GITHUB_USERNAME
                    value: "bacherik"
                  - name: GITHUB_REPOSITORY
                    value: "killedby.json"
                  ports:
                  - containerPort: 8080

          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: killedby
            namespace: killedbypr${{ github.event.pull_request.number }}
          spec:
            selector:
              app: killedby
            ports:
            - protocol: TCP
              port: 80
              targetPort: 8080

          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: killedby
            namespace: killedbypr${{ github.event.pull_request.number }}
            annotations:
              cert-manager.io/cluster-issuer: "letsencrypt"
              kubernetes.io/ingress.class: traefik
              ingress.kubernetes.io/whitelist-source-range: "192.168.0.0/16"
          spec:
            tls:
            - hosts:
              - pr-${{ github.event.pull_request.number }}.killedby.bacherik.de
              secretName: pr${{ github.event.pull_request.number }}-killedby-tls
            rules:
            - host: pr-${{ github.event.pull_request.number }}.killedby.bacherik.de
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: killedby
                      port:
                        number: 80
          EOF

  cleanup:
    if: ${{ github.event.action == 'closed' }}
    runs-on: ubuntu-latest

    steps:
    - name: Cleanup Kubernetes Resources
      uses: actions-hub/kubectl@master
      env:
        KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
      with:
        args: delete namespace killedbypr${{ github.event.pull_request.number }}
